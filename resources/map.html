<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Map The Things Network</title>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.4.min.js"
          integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
          crossorigin="anonymous"></script>
  <style type="text/css">
    #mapid { height: 500px; }
  </style>
</head>
<body>
  <h1>Map The Things Network</h1>
  <h3>Open project to build a coverage map for
    <a href="http://thethingsnetwork.org">The Things Network</a></h3>
  <div id="mapid"></div>
  <div id="boundsid">Bounds: </div>
  <h2>Collecting Data</h2>
  <p>We want your data in whatever way it is available.
    We'll build out different ways to submit as we go.</p>
  <h3>1. Map The Things - App &amp; Node (Pending)</h3>
  <p>Use the Map The Things
  <a href="http://github.com/things-nyc/mapthethings-ios">iOS app</a> and
  <a href="http://github.com/things-nyc/mapthethings-node">hardware node</a>
  to submit coverage samples.</p>
  <p>You start the node and start the app and then
    move around the coverage area, either as part of a specific data gathering
    mission or just a normal day's wandering. The app will track both successful
    and unsuccessful transmissions via TTN, thereby distinguishing between
    untested areas and those that have been tested and found wanting.</p>
  <h3>2. Custom Nodes</h3>
  <p>You are welcome to create your own nodes and use them to
  transmit GPS coordinates to the Map The Things server.</p>
  <ul>
    <li>AppSKey:&nbsp;<code>430D53B272A647AF5DFF6A167AB79A20</code></li>
    <li>NwkSKey:&nbsp;<code>804243642C1E3B04366D36C3909FCAA2</code></li>
    <li>Data:&nbsp;Send text strings of the form
      <code>{"lat":40.7128,"lng":-74.0059}</code> or just
      <code>40.7128,-74.0059</code></li>
  </ul>
  <h3>3. Upload Data</h3>
  <p>If you want to upload existing map data, submit a pull request with your
  data in a reasonable format (CSV, JSON, XML, YAML, EDN) in the
  <a href="http://github.com/things-nyc/mapthethings/data">project/data</a>
  directory. Make certain to include GPS coordinates, RSSI and SNR values
  for successful TTN messages. Samples missing RSSI or SNR indicate failed
  transmissions.</p>
  <script>
  var newyork = [40.7128, -74.0059]
  var dataloc = [20.0, 20.0]
  var mymap = L.map('mapid').setView(newyork, 13);

  //L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
  L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 18,
      id: 'mapbox.mapbox-streets-v4',
      //accessToken: 'pk.eyJ1IjoiZnJhbmtsZW9ucm9zZSIsImEiOiJjaW9sbm5pcWEwMXFwdjRqYjRmNHgxZ2s1In0.tk3zEksdrebcG4_KKUAL4Q'
  }).addTo(mymap);

  mymap.on('moveend', function (e) {
    console.log("Bounds changed")
    var bounds = mymap.getBounds();
    loadGrids(bounds)
  })

  var makeMarker = function (cell) {
    var marker = L.polygon([
        [cell.lat1, cell.lon1],
        [cell.lat2, cell.lon1],
        [cell.lat2, cell.lon2],
        [cell.lat1, cell.lon2]
    ])
    // var marker = L.circle([cell.clat, cell.clon], 500, {
    //   color: 'blue',
    //   fillColor: '#33F',
    //   fillOpacity: 0.5
    //   })

    marker.bindPopup("TTN Messages: " + cell["rssi-cnt"]);

    return marker
  }
  var markers = null;
  var removeMarkers = function (m) {
    if (m!=null) {
      window.setTimeout(function () {
        console.log("Removing markers from Map")
        $.each( m, function( i, p ) {
          mymap.removeLayer(p)
        })
      }, 500)
    }
  }
  var loadGrids = function (bounds) {
    var lon1 = bounds.getWest()
    var lon2 = bounds.getEast()
    var lat1 = bounds.getNorth()
    var lat2 = bounds.getSouth()
    $("#boundsid").text("Bounds: [" + lat1 + ", " + lon1 + "], [" + lat2 + ", " + lon2 + "]")
    var apiurl = "/api/v0/grids/" + lat1 + "/" + lon1 + "/" + lat2  + "/" + lon2
    $.getJSON(apiurl, function( data ) {
      console.log(data)
      var polygons = [];
      //data = ["https://s3.amazonaws.com/com.futurose.thingsburg.grids/0E70E703e-v0"]
      $.each( data, function( i, url ) {
        $.getJSON( url, function( grid ) {
          console.log("Grid loaded from: " + url)
          console.log(grid)
          $.each( grid.cells, function (key, cell) {
            var marker = makeMarker(cell)
            marker.addTo(mymap)
            polygons.push(marker)
          })
        })
      })
      removeMarkers(markers)
      markers = polygons;
    })
  }
  loadGrids(mymap.getBounds())
  </script>
</body>
</html>
