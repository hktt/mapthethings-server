<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Thingsburg</title>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.4.min.js"
          integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
          crossorigin="anonymous"></script>
  <style type="text/css">
    #mapid { height: 500px; }
  </style>
</head>
<body>
  <h2>Welcome to Thingsburg</h2>
  <div id="mapid"></div>
  <script>
  var newyork = [40.7128, -74.0059]
  var dataloc = [20.0, 20.0]
  var mymap = L.map('mapid').setView(dataloc, 13);
  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 18,
      id: 'mapbox.mapbox-streets-v7',
      accessToken: 'pk.eyJ1IjoiZnJhbmtsZW9ucm9zZSIsImEiOiJjaW9sbm5pcWEwMXFwdjRqYjRmNHgxZ2s1In0.tk3zEksdrebcG4_KKUAL4Q'
  }).addTo(mymap);

  mymap.on('moveend', function (e) {
    console.log("Bounds changed")
    var bounds = mymap.getBounds();
    loadGrids(bounds)
  })

  var loadGrids = function (bounds) {
    var lon1 = bounds.getWest()
    var lon2 = bounds.getEast()
    var lat1 = bounds.getNorth()
    var lat2 = bounds.getSouth()
    var apiurl = "/api/v0/refs/" + lat1 + "/" + lon1 + "/" + lat2  + "/" + lon2
    $.getJSON(apiurl, function( data ) {
      console.log(data)
      var items = [];
      //data = ["https://s3.amazonaws.com/com.futurose.thingsburg.grids/0E70E703e-v0"]
      $.each( data, function( i, url ) {
        $.getJSON( url, function( grid ) {
          console.log("Grid loaded from: " + url)
          console.log(grid)
          $.each( grid.cells, function (key, cell) {
            var polygon = L.polygon([
                [cell.lon1, cell.lat1],
                [cell.lon2, cell.lat1],
                [cell.lon2, cell.lat2],
                [cell.lon1, cell.lat2]
            ]).addTo(mymap);
          })
        })
      });
    })
  }
  loadGrids(mymap.getBounds())
    //
    // $( "<ul/>", {
    //   "class": "my-new-list",
    //   html: items.join( "" )
    // }).appendTo( "body" );
  </script>
</body>
</html>
